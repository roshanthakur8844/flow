<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Us // Sync</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600&family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0c1b; /* Deep Night */
            --panel: rgba(255, 255, 255, 0.08);
            --primary: #ffacc7; /* Soft Pink */
            --accent: #a4adff;  /* Periwinkle */
            --text: #f0f0f0;
            --font-main: 'Outfit', sans-serif;
            --font-serif: 'Playfair Display', serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background: var(--bg); color: var(--text);
            font-family: var(--font-main);
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- BACKGROUND ANIMATION --- */
        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(1px 1px at 20px 30px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 50px 160px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0));
            background-size: 200px 200px;
            z-index: -1; opacity: 0.5;
            animation: twinkle 10s linear infinite;
        }
        @keyframes twinkle { from {transform: translateY(0);} to {transform: translateY(-200px);} }

        /* --- SETUP SCREEN --- */
        .setup-screen {
            position: absolute; inset: 0; background: var(--bg); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center;
        }
        .setup-card {
            background: rgba(255,255,255,0.05); backdrop-filter: blur(10px);
            padding: 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1);
            width: 100%; max-width: 350px;
        }
        
        h1 { font-family: var(--font-serif); font-size: 2rem; margin-bottom: 10px; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; color: transparent; }
        
        input {
            width: 100%; padding: 15px; margin: 10px 0;
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px; color: white; text-align: center; font-size: 1rem;
        }
        input:focus { outline: none; border-color: var(--primary); }

        .btn-love {
            background: linear-gradient(135deg, var(--primary), #ff7eb3);
            border: none; color: #fff; padding: 15px; width: 100%;
            border-radius: 50px; font-weight: 600; margin-top: 15px;
            font-size: 1rem; cursor: pointer; box-shadow: 0 5px 20px rgba(255, 172, 199, 0.4);
            transition: 0.3s;
        }
        .btn-love:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(255, 172, 199, 0.6); }

        /* --- MAIN UI --- */
        .header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to bottom, rgba(15,12,27,0.9), transparent);
        }
        .clocks { display: flex; gap: 20px; text-align: center; }
        .clock-label { font-size: 0.6rem; text-transform: uppercase; color: rgba(255,255,255,0.5); letter-spacing: 1px; }
        .clock-time { font-family: var(--font-serif); font-size: 1.1rem; }

        .chat-area {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }

        .bubble {
            max-width: 75%; padding: 12px 18px; border-radius: 20px;
            font-size: 0.95rem; line-height: 1.4; position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .bubble.me {
            align-self: flex-end; background: var(--primary); color: #2c0b16;
            border-bottom-right-radius: 4px;
        }
        .bubble.her {
            align-self: flex-start; background: rgba(255,255,255,0.1);
            border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.1);
        }
        .bubble img { max-width: 100%; border-radius: 12px; margin-top: 5px; }

        /* PULSE EFFECT (The Touch Feature) */
        .heart-pulse {
            position: fixed; inset: 0; background: radial-gradient(circle, rgba(255,172,199,0.3) 0%, transparent 70%);
            pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 50;
        }
        .heart-pulse.active { opacity: 1; animation: heartbeat 1s ease-in-out; }
        @keyframes heartbeat { 0% {transform: scale(0.9);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        /* INPUT BAR */
        .input-bar {
            padding: 15px; background: rgba(255,255,255,0.05);
            backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; gap: 10px; align-items: center;
        }
        
        .btn-icon {
            background: transparent; border: none; color: var(--primary);
            font-size: 1.5rem; cursor: pointer; padding: 5px;
            transition: 0.2s;
        }
        .btn-icon:hover { transform: scale(1.2); }
        .btn-heart { color: #ff4d6d; }

        textarea {
            flex: 1; background: transparent; border: none; color: white;
            font-family: var(--font-main); font-size: 1rem; resize: none;
            height: 24px; max-height: 100px; padding: 0;
        }
        textarea:focus { outline: none; }
        
        /* Connection Status */
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #444;
            position: absolute; top: 20px; right: 20px;
        }
        .status-dot.online { background: #00ff88; box-shadow: 0 0 10px #00ff88; }
        
    </style>
</head>
<body>

    <div class="stars"></div>
    <div id="heartOverlay" class="heart-pulse"></div>

    <div id="setup" class="setup-screen">
        <div class="setup-card">
            <h1>Us &hearts; Sync</h1>
            <p style="font-size:0.8rem; color:rgba(255,255,255,0.6); margin-bottom:20px;">
                Long Distance Connection
            </p>
            
            <input id="myName" placeholder="Your First Name">
            <input id="herName" placeholder="Her First Name">
            
            <p style="font-size:0.7rem; color:rgba(255,255,255,0.4); margin: 15px 0;">
                (She must enter the names in the SAME order)
            </p>

            <select id="timeOffset" style="width:100%; padding:10px; margin-bottom:15px; background:rgba(0,0,0,0.3); color:white; border:1px solid #444; border-radius:10px;">
                <option value="0">Same Time Zone</option>
                <option value="-5">USA (East Coast) is -5h</option>
                <option value="-8">USA (West Coast) is -8h</option>
                <option value="-12">Other Side of World</option>
                <option value="custom">I'll set manually later</option>
            </select>

            <button class="btn-love" onclick="connectToLove()">Connect Hearts</button>
        </div>
    </div>

    <div id="app" style="display:none; flex-direction:column; height:100%;">
        <div class="status-dot" id="connStatus"></div>

        <header class="header">
            <div class="clocks">
                <div>
                    <div class="clock-label">Me</div>
                    <div id="clockMe" class="clock-time">--:--</div>
                </div>
                <div>
                    <div class="clock-label" style="color:var(--primary)">Her</div>
                    <div id="clockHer" class="clock-time" style="color:var(--primary)">--:--</div>
                </div>
            </div>
        </header>

        <div id="chatFeed" class="chat-area">
            <div style="text-align:center; font-size:0.8rem; color:rgba(255,255,255,0.3); margin-top:50%">
                Waiting for her...<br>
                Look at the same stars.
            </div>
        </div>

        <div class="input-bar">
            <input type="file" id="imgInput" hidden accept="image/*">
            <button class="btn-icon" onclick="document.getElementById('imgInput').click()">ðŸ“·</button>
            
            <textarea id="msgInput" placeholder="Message..."></textarea>
            
            <button class="btn-icon btn-heart" id="heartBtn">â™¥</button>
            
            <button class="btn-icon" onclick="sendText()">âž¤</button>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playPing() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.frequency.setValueAtTime(800, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.3);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime+0.3);
        }
    </script>

    <script>
        let peer, conn;
        let offset = 0;
        
        // --- 1. CONNECTION LOGIC ---
        function connectToLove() {
            const name1 = document.getElementById('myName').value.trim().toLowerCase();
            const name2 = document.getElementById('herName').value.trim().toLowerCase();
            offset = parseInt(document.getElementById('timeOffset').value);

            if(!name1 || !name2) return alert("Please enter both names");

            // ALGORITHM: Alphabetical Sort to ensure IDs match
            // If I am Alex and she is Sam:
            // My ID: alex-sam
            // Target ID: sam-alex
            // Wait... that doesn't work for P2P. We need a consistent Host/Join pattern or same ID logic.
            
            // BETTER STRATEGY: 
            // We create a "Room Name" by sorting names alphabetically.
            // Room: "alex-sam"
            // But PeerJS needs unique IDs per user.
            // So: I am "alex-sam-[myName]"
            // She is "alex-sam-[herName]"
            
            // To connect, I try to connect to the "other" ID.
            
            const roomPrefix = [name1, name2].sort().join('-');
            const myPeerId = roomPrefix + "-" + name1; 
            const herPeerId = roomPrefix + "-" + name2;

            document.getElementById('setup').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            startClocks();

            peer = new Peer(myPeerId);

            peer.on('open', (id) => {
                console.log("My ID:", id);
                connectToPeer(herPeerId);
            });

            peer.on('connection', (c) => {
                handleConnection(c);
            });

            peer.on('error', (err) => {
                console.log("Waiting for her...");
                // Retry logic if she isn't online yet
                setTimeout(() => connectToPeer(herPeerId), 3000);
            });
        }

        function connectToPeer(targetId) {
            const c = peer.connect(targetId);
            c.on('open', () => handleConnection(c));
            c.on('error', (e) => console.log("Retrying..."));
        }

        function handleConnection(c) {
            conn = c;
            document.getElementById('connStatus').classList.add('online');
            document.getElementById('chatFeed').innerHTML = `<div style="text-align:center; color:var(--primary); font-size:0.8rem; margin-top:20px;">â™¥ She is here â™¥</div>`;
            
            conn.on('data', (data) => {
                if(data.type === 'text') addMessage(data.content, 'her');
                if(data.type === 'image') addImage(data.content, 'her');
                if(data.type === 'pulse') triggerPulse();
            });
            
            // Keep Alive
            setInterval(() => { if(conn.open) conn.send({type:'ping'}); }, 5000);
        }

        // --- 2. MESSAGING ---
        function sendText() {
            const el = document.getElementById('msgInput');
            const txt = el.value.trim();
            if(!txt) return;

            addMessage(txt, 'me');
            if(conn && conn.open) conn.send({type: 'text', content: txt});
            el.value = '';
        }

        // Image Handling
        document.getElementById('imgInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const base64 = event.target.result;
                addImage(base64, 'me');
                if(conn && conn.open) conn.send({type: 'image', content: base64});
            };
            reader.readAsDataURL(file);
        });

        // Pulse (The Touch Feature)
        document.getElementById('heartBtn').addEventListener('click', () => {
            // Visual feedback for me
            const btn = document.getElementById('heartBtn');
            btn.style.transform = "scale(1.5)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);
            
            // Send to her
            if(conn && conn.open) conn.send({type: 'pulse'});
        });

        function triggerPulse() {
            playPing();
            const overlay = document.getElementById('heartOverlay');
            overlay.classList.add('active');
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]); // Phone Vibrate
            setTimeout(() => overlay.classList.remove('active'), 1000);
        }

        // --- 3. UI HELPERS ---
        function addMessage(txt, who) {
            const div = document.createElement('div');
            div.className = `bubble ${who}`;
            div.innerText = txt;
            const feed = document.getElementById('chatFeed');
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        function addImage(src, who) {
            const div = document.createElement('div');
            div.className = `bubble ${who}`;
            div.innerHTML = `<img src="${src}">`;
            const feed = document.getElementById('chatFeed');
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        // --- 4. CLOCKS ---
        function startClocks() {
            setInterval(() => {
                const now = new Date();
                
                // My Time
                document.getElementById('clockMe').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                // Her Time (Calculated via Offset)
                // This is a rough estimation. Ideally we use timezone strings, but offset is easier for a simple input.
                const herTime = new Date(now.getTime() + (offset * 60 * 60 * 1000));
                document.getElementById('clockHer').innerText = herTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }, 1000);
        }

        // Auto-resize Textarea
        const tx = document.getElementById('msgInput');
        tx.addEventListener("input", function(){
            this.style.height = "auto";
            this.style.height = (this.scrollHeight) + "px";
        });

    </script>
</body>
</html>
