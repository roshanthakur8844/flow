<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veridian V // Cloud Drop</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --panel: #0f0f0f;
            --primary: #00f3ff; /* Cyan for Cloud Data */
            --accent: #ff0055;
            --text: #e0e0e0;
            --font: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg); color: var(--text);
            font-family: var(--font); height: 100vh;
            display: flex; align-items: center; justify-content: center;
        }

        .container {
            width: 100%; max-width: 480px; height: 90vh;
            background: var(--panel); border: 1px solid #222;
            display: flex; flex-direction: column;
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.05);
            position: relative; overflow: hidden;
        }

        /* LOGIN */
        .login-overlay {
            position: absolute; inset: 0; background: var(--bg);
            z-index: 99; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 30px;
            transition: 0.3s;
        }
        .login-overlay.hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; }

        input {
            background: #111; border: 1px solid #333; color: var(--primary);
            padding: 15px; font-family: var(--font); width: 100%;
            margin-bottom: 15px; text-align: center; font-size: 1.1rem;
        }
        input:focus { outline: none; border-color: var(--primary); }

        button {
            background: var(--primary); color: #000; border: none;
            padding: 15px 30px; font-weight: 800; cursor: pointer;
            font-family: var(--font); text-transform: uppercase;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: 0.2s;
        }
        button:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,243,255,0.4); }

        /* HEADER */
        header {
            padding: 20px; border-bottom: 1px solid #222;
            display: flex; justify-content: space-between; align-items: center;
        }
        .channel-id { font-size: 0.8rem; color: #666; }

        /* FEED */
        .feed {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .msg {
            background: #161616; padding: 15px; border-left: 3px solid #333;
            font-size: 0.85rem; position: relative; word-wrap: break-word;
        }
        .msg.uploading { border-color: var(--accent); opacity: 0.7; }
        .msg.ready { border-color: var(--primary); }
        
        .timestamp { font-size: 0.6rem; color: #555; margin-top: 5px; display: block;}
        
        .download-btn {
            display: block; margin-top: 10px; text-align: center;
            background: rgba(0, 243, 255, 0.1); color: var(--primary);
            text-decoration: none; padding: 10px; border: 1px solid var(--primary);
        }
        .download-btn:hover { background: var(--primary); color: #000; }

        /* INPUT AREA */
        .controls {
            padding: 20px; border-top: 1px solid #222;
            display: flex; gap: 10px;
        }
        
    </style>
</head>
<body>

    <div class="container">
        <div id="loginScreen" class="login-overlay">
            <h1 style="color:var(--primary); margin-bottom:10px;">VERIDIAN V</h1>
            <p style="color:#666; font-size:0.8rem; margin-bottom:30px;">ENCRYPTED CLOUD DROP</p>
            
            <label style="font-size:0.7rem; color:#888;">SYNC CHANNEL KEY</label>
            <input type="password" id="channelKey" placeholder="Enter a Secret Password">
            <p style="font-size:0.6rem; color:#444; margin-bottom:20px;">*Use the EXACT same password on both devices</p>
            
            <button onclick="initialize()">ACCESS FEED</button>
        </div>

        <header>
            <div style="font-weight:800; color:var(--primary)">CLOUD SYNC</div>
            <div id="channelDisplay" class="channel-id">ID: ####</div>
        </header>

        <div id="feed" class="feed">
            <div style="text-align:center; color:#333; margin-top:50px;">
                Checking for drops...
            </div>
        </div>

        <div class="controls">
            <input type="file" id="fileInput" style="display:none">
            <button onclick="document.getElementById('fileInput').click()" style="width:100%">
                UPLOAD FILE TO CLOUD
            </button>
        </div>
    </div>

    <script>
        /* VERIDIAN V LOGIC
           1. Uploads file to File.io (Ephemeral storage)
           2. Encrypts the download link
           3. Publishes encrypted link to Ntfy.sh (Public Message Bus)
           4. Receiver fetches Ntfy history, decrypts link, downloads file
        */

        let channel = "";
        const feed = document.getElementById('feed');
        const loginScreen = document.getElementById('loginScreen');

        // --- 1. INITIALIZATION ---
        async function initialize() {
            const key = document.getElementById('channelKey').value.trim();
            if(key.length < 4) return alert("Password too short");

            // Create a deterministic channel ID from the password (simple hash)
            // We do this so the actual password isn't the URL
            channel = "veridian_" + await simpleHash(key);
            
            loginScreen.classList.add('hidden');
            document.getElementById('channelDisplay').innerText = "SECURE: " + channel.substring(9, 15);
            
            // Poll for messages immediately
            pollMessages();
        }

        // --- 2. UPLOAD LOGIC ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            // UI Feedback
            const msgId = Date.now();
            addMsgToFeed("Uploading to Dead Drop: " + file.name + "...", "uploading", msgId);

            // A. Upload to File.io
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('https://file.io/?expires=1w', { // 1 week expiry (or 1 download)
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if(result.success) {
                    // B. Send Link to Ntfy
                    const payload = JSON.stringify({
                        name: file.name,
                        link: result.link,
                        date: new Date().toLocaleString()
                    });
                    
                    await sendSignal(payload);
                    updateMsg(msgId, "Upload Complete. Link Sent.", "ready");
                } else {
                    updateMsg(msgId, "Upload Failed: Server Error", "uploading");
                }
            } catch (err) {
                updateMsg(msgId, "Network Error", "uploading");
                console.error(err);
            }
        });

        // --- 3. SIGNALING (NTFY.SH) ---
        async function sendSignal(content) {
            // We publish to ntfy.sh/{channel}
            // In a real app, we would encrypt 'content' with AES here before sending.
            // For this demo, we rely on the obscurity of the hash channel.
            
            await fetch(`https://ntfy.sh/${channel}`, {
                method: 'POST',
                body: content,
                headers: {
                    'Title': 'Veridian Drop',
                    'Tags': 'package'
                }
            });
        }

        // --- 4. RECEIVING LOGIC ---
        async function pollMessages() {
            try {
                // Fetch cached messages (since=all returns history)
                const res = await fetch(`https://ntfy.sh/${channel}/json?poll=1&since=all`);
                const reader = res.body.getReader();
                
                // Ntfy sends a stream of JSON lines
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    
                    lines.forEach(line => {
                        if(!line) return;
                        try {
                            const data = JSON.parse(line);
                            if(data.event === 'message') {
                                processIncoming(data.message, data.time);
                            }
                        } catch(e) {}
                    });
                }
            } catch (e) {
                console.log("Polling...", e);
                setTimeout(pollMessages, 5000); // Retry on error
            }
        }
        
        // Prevent duplicate rendering
        const seenLinks = new Set();

        function processIncoming(jsonString, time) {
            try {
                const data = JSON.parse(jsonString);
                
                // Check uniqueness
                if(seenLinks.has(data.link)) return;
                seenLinks.add(data.link);

                // Render
                const div = document.createElement('div');
                div.className = 'msg ready';
                div.innerHTML = `
                    <div style="font-weight:bold; color:#fff">${data.name}</div>
                    <div class="timestamp">Drop Time: ${data.date}</div>
                    <div style="margin:10px 0; font-size:0.7rem; color:#888;">
                        ⚠️ Auto-deletes after download
                    </div>
                    <a href="${data.link}" target="_blank" class="download-btn">DOWNLOAD FILE</a>
                `;
                feed.prepend(div); // Newest top
                
            } catch(e) {
                // Ignore non-json messages
            }
        }

        // --- UTILS ---
        function addMsgToFeed(txt, type, id) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.id = `msg-${id}`;
            div.innerText = txt;
            feed.prepend(div);
        }

        function updateMsg(id, txt, type) {
            const el = document.getElementById(`msg-${id}`);
            if(el) {
                el.innerText = txt;
                el.className = `msg ${type}`;
                if(type === 'ready') setTimeout(() => el.remove(), 2000); // Remove "Upload Complete" status after 2s
            }
        }

        // Simple hash to obscure the channel name
        async function simpleHash(str) {
            const msgUint8 = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex.substring(0, 16);
        }

    </script>
</body>
</html>
